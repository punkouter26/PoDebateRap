@page "/diag"
@using Radzen
@using Radzen.Blazor
@inject HttpClient Http
@inject ILogger<Diag> Logger
@inject IJSRuntime JSRuntime
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@implements IDisposable

<div class="diagnostics-page">
    <!-- Breadcrumb Navigation -->
    <RadzenBreadCrumb class="breadcrumb-nav">
        <RadzenBreadCrumbItem Path="/" Text="üè† Home" />
        <RadzenBreadCrumbItem Text="üîß Diagnostics" />
    </RadzenBreadCrumb>

    <RadzenStack Gap="1rem" class="diagnostics-header">
        <RadzenText TextStyle="TextStyle.H4" class="diagnostics-title">üîß System Diagnostics</RadzenText>
        <RadzenText TextStyle="TextStyle.Subtitle1" class="diagnostics-subtitle">Service Health & Audio Testing</RadzenText>
    </RadzenStack>
    
    <div class="diagnostics-body">
        @if (_isLoading)
        {
            <!-- Skeleton loading state -->
            <RadzenCard class="health-summary-skeleton">
                <RadzenStack Gap="0.5rem">
                    <RadzenSkeleton style="width: 200px; height: 24px;" />
                    <RadzenSkeleton style="width: 180px; height: 16px;" />
                </RadzenStack>
            </RadzenCard>
            
            <RadzenStack Gap="0.5rem" class="skeleton-table">
                @for (int i = 0; i < 4; i++)
                {
                    <RadzenCard class="skeleton-row">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                            <RadzenSkeleton style="width: 150px; height: 20px;" />
                            <RadzenSkeleton Shape="SkeletonShape.Circle" style="width: 30px; height: 30px;" />
                            <RadzenSkeleton style="flex: 1; height: 20px;" />
                            <RadzenSkeleton style="width: 80px; height: 20px;" />
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        }
        else if (_healthReport == null)
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Dark" AllowClose="false">
                No diagnostic results available.
            </RadzenAlert>
        }
        else
        {
            <RadzenCard class="@($"health-summary {(_healthReport.IsHealthy ? "healthy" : "unhealthy")}")">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.H6">
                            Overall Status: 
                            <RadzenBadge BadgeStyle="@(_healthReport.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                         Text="@_healthReport.Status" />
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" class="timestamp-text">
                            Checked at: @_healthReport.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                        </RadzenText>
                    </RadzenStack>
                    @if (_healthReport.IsHealthy)
                    {
                        <span class="health-icon">‚úÖ</span>
                    }
                    else
                    {
                        <span class="health-icon">‚ùå</span>
                    }
                </RadzenStack>
            </RadzenCard>
            
            <RadzenDataGrid Data="@_healthReport.Checks" 
                            TItem="HealthCheck"
                            AllowSorting="false"
                            class="diagnostics-grid">
                <Columns>
                    <RadzenDataGridColumn TItem="HealthCheck" Property="Name" Title="Check" Width="180px">
                        <Template Context="check">
                            <RadzenText TextStyle="TextStyle.Body1" class="check-name">@FormatCheckName(check.Name)</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="HealthCheck" Property="Status" Title="Status" Width="100px" TextAlign="TextAlign.Center">
                        <Template Context="check">
                            @if (check.Status == "Healthy")
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" class="status-badge">‚úî</RadzenBadge>
                            }
                            else if (check.Status == "Degraded")
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Warning" IsPill="true" class="status-badge">‚ö†</RadzenBadge>
                            }
                            else
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Danger" IsPill="true" class="status-badge">‚úñ</RadzenBadge>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="HealthCheck" Property="Description" Title="Details">
                        <Template Context="check">
                            <RadzenText TextStyle="TextStyle.Body2">@(check.Description ?? "No description")</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="HealthCheck" Property="Duration" Title="Duration" Width="100px" TextAlign="TextAlign.Right">
                        <Template Context="check">
                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@($"{check.Duration:F2}ms")" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }
    </div>
    
    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="diagnostics-footer" Wrap="FlexWrap.Wrap">
        <RadzenButton Icon="refresh" 
                      Text="@(_isLoading ? "Running..." : "Re-run Diagnostics")"
                      ButtonStyle="ButtonStyle.Primary"
                      Disabled="@_isLoading"
                      Click="@RunDiagnostics" />
        <RadzenButton Icon="volume_up"
                      Text="@(_isTestingAudio ? "Testing..." : "Test Audio")"
                      ButtonStyle="ButtonStyle.Secondary"
                      Disabled="@_isTestingAudio"
                      Click="@TestTextToSpeech" />
        <RadzenButton Icon="home"
                      Text="Back to Home"
                      ButtonStyle="ButtonStyle.Light"
                      Click="@(() => NavigationManager.NavigateTo("/"))" />
    </RadzenStack>
</div>

@* Audio interop is now handled by the shared audio-interop.js file loaded in index.html *@

@code {
    private DotNetObjectReference<Diag>? objRef;
    private HealthReport? _healthReport;
    private bool _isLoading = true;
    private bool _isTestingAudio = false;
    private CancellationTokenSource _cts = new CancellationTokenSource();

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        await RunDiagnostics();
    }

    private async Task RunDiagnostics()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var response = await Http.GetFromJsonAsync<HealthReport>("api/health");
            _healthReport = response;
            
            if (_healthReport?.IsHealthy == true)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Diagnostics Complete", "All systems operational", 3000);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Issues Detected", "Some services may be degraded", 5000);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error running diagnostics.");
            NotificationService.Notify(NotificationSeverity.Error, "Diagnostics Failed", ex.Message, 5000);
            _healthReport = new HealthReport
            {
                status = "Unhealthy",
                isHealthy = false,
                timestamp = DateTime.UtcNow,
                checks = new List<HealthCheck>
                {
                    new HealthCheck
                    {
                        name = "Overall",
                        status = "Unhealthy",
                        description = $"Error: {ex.Message}",
                        duration = 0
                    }
                }
            };
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private string FormatCheckName(string name)
    {
        // Convert snake_case to Title Case
        return string.Join(" ", name.Split('_')
            .Select(word => char.ToUpper(word[0]) + word.Substring(1)));
    }


    private async Task TestTextToSpeech()
    {
        if (_isTestingAudio) return;
        
        _isTestingAudio = true;
        NotificationService.Notify(NotificationSeverity.Info, "Testing Audio", "Generating speech...", 2000);
        StateHasChanged();
        
        try
        {
            Logger.LogInformation("Manual TTS test button clicked");
            
            // Simple test using the TTS service via the AI controller
            var testText = "Hello! This is a text to speech test from the diagnostics page. If you can hear this, the audio system is working correctly.";
            
            // Use capitalized property names to match C# model (GenerateSpeechRequest)
            var requestBody = new { Text = testText, VoiceName = "en-US-JennyNeural" };
            var response = await Http.PostAsJsonAsync("AI/generate-speech", requestBody);
            
            if (response.IsSuccessStatusCode)
            {
                var audioBytes = await response.Content.ReadAsByteArrayAsync();
                if (audioBytes != null && audioBytes.Length > 0 && objRef != null)
                {
                    Logger.LogInformation("‚úÖ TTS test successful. Playing audio with {Length} bytes", audioBytes.Length);
                    NotificationService.Notify(NotificationSeverity.Success, "Audio Ready", "Playing test audio...", 3000);
                    
                    // Log first 50 bytes for debugging
                    var first50 = string.Join(" ", audioBytes.Take(50).Select(b => b.ToString("X2")));
                    Logger.LogInformation("üîç First 50 bytes of audio: {Bytes}", first50);
                    
                    var base64Audio = Convert.ToBase64String(audioBytes);
                    Logger.LogInformation("üéµ Base64 length: {Length}", base64Audio.Length);
                    
                    await JSRuntime.InvokeVoidAsync("playAudio", objRef, base64Audio);
                    Logger.LogInformation("‚úÖ Audio playback initiated");
                }
                else
                {
                    Logger.LogWarning("‚ö†Ô∏è TTS test returned no audio data");
                    NotificationService.Notify(NotificationSeverity.Warning, "No Audio", "TTS returned empty audio data", 4000);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError("‚ùå TTS test failed with status {Status}: {Error}", response.StatusCode, errorContent);
                NotificationService.Notify(NotificationSeverity.Error, "Audio Test Failed", $"Status: {response.StatusCode}", 5000);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Exception during manual TTS test");
        }
        finally
        {
            _isTestingAudio = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task NotifyAudioPlaybackComplete()
    {
        Logger.LogInformation("Audio playback completed in diagnostics page");
        _isTestingAudio = false;
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        objRef?.Dispose();
        _cts?.Cancel();
        _cts?.Dispose();
    }

    // Health Report Models (using camelCase to match server JSON response)
    public class HealthReport
    {
        public string status { get; set; } = string.Empty;
        public bool isHealthy { get; set; }
        public DateTime timestamp { get; set; }
        public List<HealthCheck> checks { get; set; } = new();
        
        // PascalCase properties for component usage (map from camelCase)
        [System.Text.Json.Serialization.JsonIgnore]
        public string Status => status;
        [System.Text.Json.Serialization.JsonIgnore]
        public bool IsHealthy => isHealthy;
        [System.Text.Json.Serialization.JsonIgnore]
        public DateTime Timestamp => timestamp;
        [System.Text.Json.Serialization.JsonIgnore]
        public List<HealthCheck> Checks => checks;
    }

    public class HealthCheck
    {
        public string name { get; set; } = string.Empty;
        public string status { get; set; } = string.Empty;
        public string? description { get; set; }
        public double duration { get; set; }
        public string? exception { get; set; }
        
        // PascalCase properties for component usage (map from camelCase)
        [System.Text.Json.Serialization.JsonIgnore]
        public string Name => name;
        [System.Text.Json.Serialization.JsonIgnore]
        public string Status => status;
        [System.Text.Json.Serialization.JsonIgnore]
        public string? Description => description;
        [System.Text.Json.Serialization.JsonIgnore]
        public double Duration => duration;
        [System.Text.Json.Serialization.JsonIgnore]
        public string? Exception => exception;
    }
}
