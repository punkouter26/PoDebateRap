@using Radzen
@using Radzen.Blazor

<div class="health-cards-container">
    @if (IsLoading)
    {
        <!-- Skeleton loading state -->
        <RadzenCard class="health-summary-skeleton">
            <RadzenStack Gap="0.5rem">
                <RadzenSkeleton style="width: 200px; height: 24px;" />
                <RadzenSkeleton style="width: 180px; height: 16px;" />
            </RadzenStack>
        </RadzenCard>
        
        <RadzenStack Gap="0.5rem" class="skeleton-table">
            @for (int i = 0; i < 4; i++)
            {
                <RadzenCard class="skeleton-row">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenSkeleton style="width: 150px; height: 20px;" />
                        <RadzenSkeleton Shape="SkeletonShape.Circle" style="width: 30px; height: 30px;" />
                        <RadzenSkeleton style="flex: 1; height: 20px;" />
                        <RadzenSkeleton style="width: 80px; height: 20px;" />
                    </RadzenStack>
                </RadzenCard>
            }
        </RadzenStack>
    }
    else if (HealthReport == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Dark" AllowClose="false">
            No diagnostic results available.
        </RadzenAlert>
    }
    else
    {
        <RadzenCard class="@($"health-summary {(HealthReport.IsHealthy ? "healthy" : "unhealthy")}")">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenStack Gap="0.25rem">
                    <RadzenText TextStyle="TextStyle.H6">
                        Overall Status: 
                        <RadzenBadge BadgeStyle="@(HealthReport.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                     Text="@HealthReport.Status" />
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption" class="timestamp-text">
                        Checked at: @HealthReport.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                    </RadzenText>
                </RadzenStack>
                @if (HealthReport.IsHealthy)
                {
                    <span class="health-icon">✅</span>
                }
                else
                {
                    <span class="health-icon">❌</span>
                }
            </RadzenStack>
        </RadzenCard>
        
        <RadzenDataGrid Data="@HealthReport.Checks" 
                        TItem="HealthCheckItem"
                        AllowSorting="false"
                        class="diagnostics-grid">
            <Columns>
                <RadzenDataGridColumn TItem="HealthCheckItem" Property="Name" Title="Check" Width="180px">
                    <Template Context="check">
                        <RadzenText TextStyle="TextStyle.Body1" class="check-name">@FormatCheckName(check.Name)</RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="HealthCheckItem" Property="Status" Title="Status" Width="100px" TextAlign="TextAlign.Center">
                    <Template Context="check">
                        @if (check.Status == "Healthy")
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Success" IsPill="true" class="status-badge">✔</RadzenBadge>
                        }
                        else if (check.Status == "Degraded")
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Warning" IsPill="true" class="status-badge">⚠</RadzenBadge>
                        }
                        else
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Danger" IsPill="true" class="status-badge">✖</RadzenBadge>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="HealthCheckItem" Property="Description" Title="Details">
                    <Template Context="check">
                        <RadzenText TextStyle="TextStyle.Body2">@(check.Description ?? "No description")</RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="HealthCheckItem" Property="Duration" Title="Duration" Width="100px" TextAlign="TextAlign.Right">
                    <Template Context="check">
                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@($"{check.Duration:F2}ms")" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
</div>

@code {
    [Parameter]
    public bool IsLoading { get; set; }

    [Parameter]
    public HealthReportModel? HealthReport { get; set; }

    private string FormatCheckName(string name)
    {
        // Convert snake_case to Title Case
        return string.Join(" ", name.Split('_')
            .Select(word => char.ToUpper(word[0]) + word.Substring(1)));
    }

    // Models for health report data
    public class HealthReportModel
    {
        public string Status { get; set; } = string.Empty;
        public bool IsHealthy { get; set; }
        public DateTime Timestamp { get; set; }
        public List<HealthCheckItem> Checks { get; set; } = new();
    }

    public class HealthCheckItem
    {
        public string Name { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string? Description { get; set; }
        public double Duration { get; set; }
        public string? Exception { get; set; }
    }
}
