@page "/leaderboard"
@using PoDebateRap.Shared.Models
@using Radzen
@using Radzen.Blazor
@inject HttpClient Http
@inject NavigationManager NavManager
@inject ILogger<Leaderboard> Logger

<PageTitle>Leaderboard | PoDebateRap</PageTitle>

<div class="leaderboard-container">
    <!-- Breadcrumb Navigation -->
    <RadzenBreadCrumb class="breadcrumb-nav">
        <RadzenBreadCrumbItem Path="/" Text="üè† Home" />
        <RadzenBreadCrumbItem Text="üèÜ Leaderboard" />
    </RadzenBreadCrumb>

    <RadzenStack Gap="1rem" class="leaderboard-header-section">
        <RadzenText TextStyle="TextStyle.H3" class="leaderboard-header">üèÜ Leaderboard</RadzenText>
        <RadzenText TextStyle="TextStyle.Subtitle1" class="leaderboard-subheader">Top Rap Battle Champions</RadzenText>
    </RadzenStack>

    <RadzenButton Icon="arrow_back" 
                  Text="Return to Debates" 
                  ButtonStyle="ButtonStyle.Secondary" 
                  Click="@NavigateHome"
                  class="btn-navigate-home" />

    @if (IsLoading)
    {
        <!-- Skeleton loading state -->
        <RadzenStack Gap="0.5rem" class="skeleton-container">
            @for (int i = 0; i < 5; i++)
            {
                <RadzenCard class="skeleton-row">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenSkeleton Shape="SkeletonShape.Circle" style="width: 40px; height: 40px;" />
                        <RadzenSkeleton style="width: 150px; height: 20px;" />
                        <RadzenSkeleton style="width: 60px; height: 20px;" />
                        <RadzenSkeleton style="width: 60px; height: 20px;" />
                        <RadzenSkeleton style="width: 80px; height: 20px;" />
                        <RadzenSkeleton style="width: 70px; height: 20px;" />
                    </RadzenStack>
                </RadzenCard>
            }
        </RadzenStack>
    }
    else if (LeaderboardEntries == null || !LeaderboardEntries.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Dark" AllowClose="false">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="info" />
                <span>No leaderboard data available yet. Start some debates!</span>
            </RadzenStack>
        </RadzenAlert>
    }
    else
    {
        <RadzenDataGrid Data="@LeaderboardEntries" 
                        TItem="RapperLeaderboardEntry"
                        AllowSorting="true"
                        AllowFiltering="false"
                        PageSize="10"
                        class="leaderboard-grid"
                        RowRender="@RowRender">
            <Columns>
                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="Rank" Title="Rank" Width="80px" Sortable="false">
                    <Template Context="entry">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            @if (entry.Rank <= 3)
                            {
                                <span class="rank-icon">@GetRankIcon(entry.Rank)</span>
                            }
                            <RadzenBadge BadgeStyle="@GetRankBadgeStyle(entry.Rank)" IsPill="true" Text="@entry.Rank.ToString()" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="Name" Title="Rapper" Width="200px">
                    <Template Context="entry">
                        <RadzenText TextStyle="TextStyle.Body1" class="rapper-name-cell">@entry.Name</RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="Wins" Title="Wins" Width="80px" TextAlign="TextAlign.Center">
                    <Template Context="entry">
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@entry.Wins.ToString()" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="Losses" Title="Losses" Width="80px" TextAlign="TextAlign.Center">
                    <Template Context="entry">
                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="@entry.Losses.ToString()" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="TotalDebates" Title="Total" Width="80px" TextAlign="TextAlign.Center" />
                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="WinPercentage" Title="Win %" Width="100px" TextAlign="TextAlign.Center">
                    <Template Context="entry">
                        <RadzenProgressBar Value="@(entry.WinPercentage * 100)" 
                                           ShowValue="true" 
                                           Mode="ProgressBarMode.Determinate"
                                           class="win-rate-bar">
                            <Template>@entry.WinPercentage.ToString("P0")</Template>
                        </RadzenProgressBar>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
</div>

@code {
    private List<RapperLeaderboardEntry>? LeaderboardEntries;
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Leaderboard page initializing.");
        IsLoading = true;
        try
        {
            var rappers = await Http.GetFromJsonAsync<List<Rapper>>("Rappers");
            if (rappers != null)
            {
                CalculateLeaderboard(rappers);
                Logger.LogInformation("Leaderboard calculated for {Count} rappers.", LeaderboardEntries?.Count ?? 0);
            }
            else
            {
                LeaderboardEntries = new List<RapperLeaderboardEntry>();
                Logger.LogWarning("No rapper data found to build leaderboard.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading data for Leaderboard page.");
            LeaderboardEntries = new List<RapperLeaderboardEntry>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void CalculateLeaderboard(List<Rapper> rappers)
    {
        LeaderboardEntries = rappers
            .Select(r => new RapperLeaderboardEntry
            {
                Name = r.Name,
                Wins = r.Wins,
                Losses = r.Losses,
                TotalDebates = r.TotalDebates,
                WinPercentage = (r.TotalDebates > 0) ? (double)r.Wins / r.TotalDebates : 0.0
            })
            .OrderByDescending(e => e.WinPercentage)
            .ThenByDescending(e => e.Wins)
            .ThenBy(e => e.Losses)
            .Take(10)
            .Select((entry, index) =>
            {
                entry.Rank = index + 1;
                return entry;
            })
            .ToList();
    }

    private void NavigateHome()
    {
        NavManager.NavigateTo("/");
    }

    private void RowRender(RowRenderEventArgs<RapperLeaderboardEntry> args)
    {
        // Add special styling for top 3 rows
        if (args.Data.Rank <= 3)
        {
            args.Attributes.Add("class", $"rank-{args.Data.Rank}");
        }
    }

    private BadgeStyle GetRankBadgeStyle(int rank) => rank switch
    {
        1 => BadgeStyle.Warning,  // Gold
        2 => BadgeStyle.Light,    // Silver
        3 => BadgeStyle.Info,     // Bronze-ish
        _ => BadgeStyle.Secondary
    };

    private string GetRankIcon(int rank) => rank switch
    {
        1 => "üèÜ",
        2 => "ü•à",
        3 => "ü•â",
        _ => ""
    };

    private class RapperLeaderboardEntry
    {
        public int Rank { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Wins { get; set; }
        public int Losses { get; set; }
        public int TotalDebates { get; set; }
        public double WinPercentage { get; set; }
    }
}
