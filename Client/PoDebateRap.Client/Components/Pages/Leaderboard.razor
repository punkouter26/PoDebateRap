@page "/leaderboard"
@using PoDebateRap.Shared.Models
@inject HttpClient Http
@inject NavigationManager NavManager
@inject ILogger<Leaderboard> Logger

<PageTitle>PoDebateRap - Leaderboard</PageTitle>

<div class="leaderboard-container">
    <div class="leaderboard-header-section">
        <RadzenText TextStyle="TextStyle.H4" class="leaderboard-title">
            <RadzenIcon Icon="emoji_events" /> Leaderboard
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Subtitle1" class="leaderboard-subtitle">
            Top Rap Battle Champions
        </RadzenText>
    </div>

    <div class="leaderboard-actions">
        <RadzenButton ButtonStyle="ButtonStyle.Light" 
                      Icon="arrow_back" 
                      Text="Return to Debates"
                      Click="@NavigateHome"
                      class="back-btn" />
        
        <RadzenButton ButtonStyle="ButtonStyle.Secondary" 
                      Icon="refresh" 
                      Text="Refresh"
                      Click="@RefreshLeaderboard"
                      IsBusy="@IsLoading"
                      class="refresh-btn" />
    </div>

    @if (IsLoading)
    {
        <div class="loading-container">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            <RadzenText TextStyle="TextStyle.Body1" class="loading-text">Loading leaderboard...</RadzenText>
        </div>
    }
    else if (LeaderboardEntries == null || !LeaderboardEntries.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Dark" AllowClose="false" class="info-alert">
            <RadzenIcon Icon="info" /> No leaderboard data available yet. Start some debates!
        </RadzenAlert>
    }
    else
    {
        <!-- Stats Summary Cards -->
        <div class="stats-cards">
            <RadzenCard class="stat-card champion">
                <div class="stat-content">
                    <span class="stat-icon">üèÜ</span>
                    <div class="stat-info">
                        <RadzenText TextStyle="TextStyle.H5" class="stat-value">@GetChampionName()</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">Current Champion</RadzenText>
                    </div>
                </div>
            </RadzenCard>
            
            <RadzenCard class="stat-card">
                <div class="stat-content">
                    <RadzenIcon Icon="sports_mma" class="stat-icon-radzen" />
                    <div class="stat-info">
                        <RadzenText TextStyle="TextStyle.H5" class="stat-value">@GetTotalDebates()</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">Total Battles</RadzenText>
                    </div>
                </div>
            </RadzenCard>
            
            <RadzenCard class="stat-card">
                <div class="stat-content">
                    <RadzenIcon Icon="trending_up" class="stat-icon-radzen" />
                    <div class="stat-info">
                        <RadzenText TextStyle="TextStyle.H5" class="stat-value">@GetBestWinRate()</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">Best Win Rate</RadzenText>
                    </div>
                </div>
            </RadzenCard>
        </div>

        <!-- RadzenDataGrid with sorting and filtering -->
        <RadzenDataGrid Data="@LeaderboardEntries" TItem="RapperLeaderboardEntry"
                        AllowFiltering="true" FilterMode="FilterMode.Simple" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        AllowSorting="true" AllowPaging="true" PageSize="10"
                        PagerHorizontalAlign="HorizontalAlign.Center"
                        ShowPagingSummary="true" PagingSummaryFormat="Showing {0} to {1} of {2} rappers"
                        class="leaderboard-grid"
                        RowRender="@OnRowRender"
                        ColumnWidth="120px">
            
            <Columns>
                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="Rank" Title="Rank" Width="80px" 
                                      Sortable="true" Filterable="false" TextAlign="TextAlign.Center">
                    <Template Context="entry">
                        <div class="rank-cell">
                            @if (entry.Rank <= 3)
                            {
                                <span class="rank-medal">@GetRankIcon(entry.Rank)</span>
                            }
                            <RadzenBadge BadgeStyle="@GetRankBadgeStyle(entry.Rank)" Text="@entry.Rank.ToString()" />
                        </div>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="Name" Title="Rapper" Width="180px"
                                      Sortable="true" Filterable="true">
                    <Template Context="entry">
                        <div class="rapper-name-cell">
                            <div class="rapper-avatar-mini">@GetInitial(entry.Name)</div>
                            <RadzenText TextStyle="TextStyle.Body1" class="rapper-name">@entry.Name</RadzenText>
                        </div>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="Wins" Title="Wins" Width="90px"
                                      Sortable="true" Filterable="false" TextAlign="TextAlign.Center">
                    <Template Context="entry">
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@entry.Wins.ToString()" class="stat-badge" />
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="Losses" Title="Losses" Width="90px"
                                      Sortable="true" Filterable="false" TextAlign="TextAlign.Center">
                    <Template Context="entry">
                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="@entry.Losses.ToString()" class="stat-badge" />
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="TotalDebates" Title="Battles" Width="100px"
                                      Sortable="true" Filterable="false" TextAlign="TextAlign.Center">
                    <Template Context="entry">
                        <RadzenText TextStyle="TextStyle.Body2">@entry.TotalDebates</RadzenText>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="RapperLeaderboardEntry" Property="WinPercentage" Title="Win %" Width="140px"
                                      Sortable="true" Filterable="false" TextAlign="TextAlign.Center">
                    <Template Context="entry">
                        <div class="win-rate-cell">
                            <RadzenProgressBar Value="@(entry.WinPercentage * 100)" ShowValue="false" 
                                               class="win-rate-bar" Style="height: 8px; width: 60px;" />
                            <RadzenText TextStyle="TextStyle.Body2" class="win-rate-text">
                                @entry.WinPercentage.ToString("P0")
                            </RadzenText>
                        </div>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
</div>

@code {
    private List<RapperLeaderboardEntry>? LeaderboardEntries;
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Leaderboard page initializing.");
        await LoadLeaderboard();
    }

    private async Task LoadLeaderboard()
    {
        IsLoading = true;
        StateHasChanged();
        
        try
        {
            var rappers = await Http.GetFromJsonAsync<List<Rapper>>("Rappers");
            if (rappers != null)
            {
                CalculateLeaderboard(rappers);
                Logger.LogInformation("Leaderboard calculated for {Count} rappers.", LeaderboardEntries?.Count ?? 0);
            }
            else
            {
                LeaderboardEntries = new List<RapperLeaderboardEntry>();
                Logger.LogWarning("No rapper data found to build leaderboard.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading data for Leaderboard page.");
            LeaderboardEntries = new List<RapperLeaderboardEntry>();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshLeaderboard()
    {
        await LoadLeaderboard();
    }

    private void CalculateLeaderboard(List<Rapper> rappers)
    {
        LeaderboardEntries = rappers
            .Select(r => new RapperLeaderboardEntry
            {
                Name = r.Name,
                Wins = r.Wins,
                Losses = r.Losses,
                TotalDebates = r.TotalDebates,
                WinPercentage = (r.TotalDebates > 0) ? (double)r.Wins / r.TotalDebates : 0.0
            })
            .OrderByDescending(e => e.WinPercentage)
            .ThenByDescending(e => e.Wins)
            .ThenBy(e => e.Losses)
            .Select((entry, index) =>
            {
                entry.Rank = index + 1;
                return entry;
            })
            .ToList();
    }

    private void NavigateHome()
    {
        NavManager.NavigateTo("/");
    }

    private string GetChampionName() => LeaderboardEntries?.FirstOrDefault()?.Name ?? "N/A";
    
    private int GetTotalDebates() => LeaderboardEntries?.Sum(e => e.TotalDebates) / 2 ?? 0;
    
    private string GetBestWinRate() => LeaderboardEntries?.FirstOrDefault()?.WinPercentage.ToString("P0") ?? "0%";

    private string GetInitial(string name) => 
        string.IsNullOrEmpty(name) ? "?" : name[0].ToString().ToUpper();

    private BadgeStyle GetRankBadgeStyle(int rank) => rank switch
    {
        1 => BadgeStyle.Warning,
        2 => BadgeStyle.Light,
        3 => BadgeStyle.Secondary,
        _ => BadgeStyle.Info
    };

    private string GetRankIcon(int rank) => rank switch
    {
        1 => "üèÜ",
        2 => "ü•à",
        3 => "ü•â",
        _ => ""
    };

    private void OnRowRender(RowRenderEventArgs<RapperLeaderboardEntry> args)
    {
        if (args.Data.Rank <= 3)
        {
            args.Attributes.Add("class", $"top-rank rank-{args.Data.Rank}");
        }
    }

    private class RapperLeaderboardEntry
    {
        public int Rank { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Wins { get; set; }
        public int Losses { get; set; }
        public int TotalDebates { get; set; }
        public double WinPercentage { get; set; }
    }
}
