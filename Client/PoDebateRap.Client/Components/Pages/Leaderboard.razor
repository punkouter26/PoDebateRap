@page "/leaderboard"
@using PoDebateRap.Shared.Models
@* Removed: @using MudBlazor *@
@inject HttpClient Http // Inject HttpClient
@inject NavigationManager NavManager
@inject ILogger<Leaderboard> Logger

<PageTitle>PoDebateRap - Leaderboard</PageTitle>

<div class="leaderboard-container">
    <h3 class="leaderboard-header">Leaderboard</h3>
    <p class="leaderboard-subheader">Top Rap Battle Champions</p>

    <button class="btn-navigate-home" @onclick="NavigateHome">
        ‚Üê Return to Debates
    </button>

    @if (IsLoading)
    {
        <p class="loading-text">Loading leaderboard...</p>
    }
    else if (LeaderboardEntries == null || !LeaderboardEntries.Any())
    {
        <div class="info-message">
            No leaderboard data available yet. Start some debates!
        </div>
    }
    else
    {
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Rapper</th>
                    <th>Wins</th>
                    <th>Losses</th>
                    <th>Total Debates</th>
                    <th>Win %</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var context in LeaderboardEntries)
                {
                    <tr>
                        <td class="rank-cell">
                            @if (context.Rank <= 3)
                            {
                                <span class="rank-icon" style="@($"color: {GetRankColor(context.Rank)};")">@GetRankIcon(context.Rank)</span>
                            }
                            <strong>@context.Rank</strong>
                        </td>
                        <td>@context.Name</td>
                        <td>@context.Wins</td>
                        <td>@context.Losses</td>
                        <td>@context.TotalDebates</td>
                        <td>@context.WinPercentage.ToString("P1")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<RapperLeaderboardEntry>? LeaderboardEntries;
    private bool IsLoading = true;

    // Removed ThemeVariables class

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Leaderboard page initializing.");
        IsLoading = true;
        try
        {
            var rappers = await Http.GetFromJsonAsync<List<Rapper>>("Rappers");
            if (rappers != null)
            {
                CalculateLeaderboard(rappers);
                Logger.LogInformation("Leaderboard calculated for {Count} rappers.", LeaderboardEntries?.Count ?? 0);
            }
            else
            {
                LeaderboardEntries = new List<RapperLeaderboardEntry>();
                Logger.LogWarning("No rapper data found to build leaderboard.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading data for Leaderboard page.");
            LeaderboardEntries = new List<RapperLeaderboardEntry>(); // Ensure list is not null on error
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void CalculateLeaderboard(List<Rapper> rappers)
    {
        LeaderboardEntries = rappers
            .Select(r => new RapperLeaderboardEntry
            {
                Name = r.Name,
                Wins = r.Wins,
                Losses = r.Losses,
                TotalDebates = r.TotalDebates,
                WinPercentage = (r.TotalDebates > 0) ? (double)r.Wins / r.TotalDebates : 0.0
            })
            .OrderByDescending(e => e.WinPercentage)
            .ThenByDescending(e => e.Wins)
            .ThenBy(e => e.Losses)
            .Take(10)
            .Select((entry, index) =>
            {
                entry.Rank = index + 1;
                return entry;
            })
            .ToList();
    }

    private void NavigateHome()
    {
        NavManager.NavigateTo("/");
    }

    private string GetRankColor(int rank) => rank switch
    {
        1 => "#FFD700", // Gold
        2 => "#C0C0C0", // Silver
        3 => "#CD7F32", // Bronze
        _ => "inherit"
    };

    private string GetRankIcon(int rank) => rank switch
    {
        1 => "üèÜ",
        2 => "ü•à",
        3 => "ü•â",
        _ => ""
    };

    private class RapperLeaderboardEntry
    {
        public int Rank { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Wins { get; set; }
        public int Losses { get; set; }
        public int TotalDebates { get; set; }
        public double WinPercentage { get; set; }
    }
}
