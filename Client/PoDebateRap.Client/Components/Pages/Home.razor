@page "/"
@using PoDebateRap.Shared.Models
@using PoDebateRap.Client.Components.Debate
@using Microsoft.JSInterop
@using System.Net.Http.Json

@inject HttpClient Http
@inject ILogger<Home> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>PoDebateRap - Home</PageTitle>

<div class="container mt-4">
    <h3 style="text-align: center; font-family: @ThemeVariables.HeaderFont; color: @ThemeVariables.PrimaryColor; margin-bottom: 0.5rem;">PoDebateRap</h3>
    <h5 style="text-align: center; color: grey; margin-bottom: 1.5rem;">AI Rap Battles</h5>

    @* Display loading error if any *@
    @if (!string.IsNullOrEmpty(LoadingErrorMessage))
    {
        <div class="error-message" role="alert">@LoadingErrorMessage</div>
    }

    <DebateSetup Rappers="Rappers"
             @bind-SelectedRapper1Name="SelectedRapper1Name"
             @bind-SelectedRapper2Name="SelectedRapper2Name"
             @bind-DebateTopicInput="DebateTopicInput"
             IsDisabled="@(IsLoading || _latestDebateState.IsGeneratingTurn || _latestDebateState.IsDebateInProgress)"
             IsLoading="IsLoading"
             IsStarting="_latestDebateState.IsGeneratingTurn"
             IsFetchingTopic="IsFetchingInitialTopic"
             IsDebateInProgress="_latestDebateState.IsDebateInProgress"
             IsVoting="ShowVotingModal"
             IsStartDisabled="IsStartDisabled()"
             InitialTopicFetchError="InitialTopicFetchError"
             TopicPlaceholder="@(IsFetchingInitialTopic ? "Fetching news topic..." : "Enter debate topic...")"
             OnStartDebate="StartDebate"
             OnStopDebate="StopDebate" />

    <!-- Debate Arena Section -->
    <div class="debate-arena">
        @if (_latestDebateState.IsDebateInProgress || _latestDebateState.IsDebateFinished)
        {
            <DebateVisualizer Rapper1="@_latestDebateState.Rapper1"
                              Rapper2="@_latestDebateState.Rapper2"
                              CurrentTurnText="@_latestDebateState.CurrentTurnText"
                              IsRapper1Active="@_latestDebateState.IsRapper1Turn"
                              IsRapper2Active="@(!_latestDebateState.IsRapper1Turn)"
                              CurrentTurnNumber="@_latestDebateState.CurrentTurnNumber"
                              TotalTurns="@_latestDebateState.TotalTurns" />
        }
        else
        {
            <h6 style="text-align: center; color: grey;">Select rappers and a topic to start the debate!</h6>
        }
    </div>

    <!-- Results Modal (HTML/CSS version - Displaying Results) -->
    @if (ShowVotingModal)
    {
        <ResultsModal Rapper1Name="@_latestDebateState.Rapper1?.Name"
                      Rapper2Name="@_latestDebateState.Rapper2?.Name"
                      TopicTitle="@_latestDebateState.Topic?.Title"
                      WinnerName="@_latestDebateState.WinnerName"
                      JudgeReasoning="@_latestDebateState.JudgeReasoning"
                      Stats="@_latestDebateState.Stats"
                      OnClose="HandleResultsModalClosed" />
    }

</div> @* End container *@



@code {
    private DotNetObjectReference<Home>? objRef;
    private DebateState _latestDebateState = new();

    private List<Rapper>? Rappers;
    private string? SelectedRapper1Name;
    private string? SelectedRapper2Name;
    private string DebateTopicInput { get; set; } = "";

    private bool IsLoading = true;
    private bool IsFetchingInitialTopic = false;
    private string? LoadingErrorMessage = null;
    private string? InitialTopicFetchError = null;

    private bool ShowVotingModal = false;

    private static class ThemeVariables
    {
        public const string HeaderFont = "'Impact', Haettenschweiler, 'Arial Narrow Bold', sans-serif";
        public const string PrimaryColor = "#FFD700"; // Using Gold for primary theme accent
        public const string AccentColor = "#CD7F32"; // Bronze for VS separator
    }

    protected override async Task OnInitializedAsync()
    {
        objRef = DotNetObjectReference.Create(this);
        Logger.LogInformation("Home page initializing.");
        IsLoading = true;
        IsFetchingInitialTopic = true;
        LoadingErrorMessage = null;
        InitialTopicFetchError = null;
        StateHasChanged();

        try
        {
            Rappers = await Http.GetFromJsonAsync<List<Rapper>>("Rappers");
            Logger.LogDebug("Retrieved {LoadedRapperCount} rappers.", Rappers?.Count ?? 0);
            if (Rappers == null || Rappers.Count == 0)
            {
                 LoadingErrorMessage = "Rapper list is empty. Check Azurite data and seeding logic.";
                 Logger.LogWarning(LoadingErrorMessage);
            }

            try
            {
                var headlines = await Http.GetFromJsonAsync<List<NewsHeadline>>("News/headlines");
                if (headlines != null && headlines.Count > 0 && !string.IsNullOrWhiteSpace(headlines[0].Title))
                {
                    DebateTopicInput = headlines[0].Title.Trim();
                    InitialTopicFetchError = null; // Clear any previous error
                    Logger.LogInformation("Pre-populated topic from news: {NewsTopic}", DebateTopicInput);
                }
                else
                {
                    InitialTopicFetchError = "Could not fetch a news topic. Please enter one manually.";
                    Logger.LogWarning("News API returned no headlines or headline had no title.");
                    DebateTopicInput = "";
                }
            }
            catch (Exception newsEx)
            {
                 Logger.LogError(newsEx, "Error fetching initial news topic from API.");
                 InitialTopicFetchError = $"Error fetching news topic from API: {newsEx.Message}. Please enter one manually.";
                 DebateTopicInput = "";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading initial data for Home page.");
            LoadingErrorMessage = $"Error loading initial data: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            IsFetchingInitialTopic = false;
            StateHasChanged();
        }
    }

    private async Task PollDebateState()
    {
        try
        {
            var newState = await Http.GetFromJsonAsync<DebateState>("Debate/state");

            if (newState == null)
            {
                Logger.LogWarning("Received null debate state from API. Stopping polling.");
                _latestDebateState = new DebateState(); // Reset state
                LoadingErrorMessage = "Debate state could not be retrieved.";
                await InvokeAsync(StateHasChanged);
                return;
            }

            _latestDebateState = newState;
            Logger.LogInformation("Received state update. Turn: {Turn}, IsGenerating: {IsGenerating}, Winner: {Winner}, CurrentTurnText length: {TextLength}",
                newState.CurrentTurnNumber, newState.IsGeneratingTurn, newState.WinnerName ?? "N/A", newState.CurrentTurnText?.Length ?? 0);

            if (newState.CurrentTurnAudio != null && newState.CurrentTurnAudio.Length > 0 && objRef != null)
            {
                Logger.LogInformation("Audio data received for turn {Turn} (length: {AudioLength}), attempting playback via JS interop.", newState.CurrentTurnNumber, newState.CurrentTurnAudio.Length);
                try
                {
                    var base64Audio = Convert.ToBase64String(newState.CurrentTurnAudio);
                    await JSRuntime.InvokeVoidAsync("playAudio", objRef, base64Audio);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error invoking JS for audio playback for turn {Turn}. Signaling completion.", newState.CurrentTurnNumber);
                    await NotifyAudioPlaybackComplete();
                }
            }
            else if (newState.IsDebateInProgress && newState.CurrentTurnNumber > 0)
            {
                Logger.LogInformation("No audio data for turn {Turn} or audio length is zero. Signaling completion immediately.", newState.CurrentTurnNumber);
                await NotifyAudioPlaybackComplete();
            }
            else if (newState.IsDebateInProgress && newState.CurrentTurnNumber == 0)
            {
                Logger.LogInformation("Initial state received (Turn 0), no audio expected yet. Waiting for first turn.");
            }
            else
            {
                Logger.LogInformation("No audio data and not in progress. No action needed for audio playback.");
            }

            if (!string.IsNullOrEmpty(newState.ErrorMessage))
            {
                 Logger.LogError("Error from orchestrator: {Error}", newState.ErrorMessage);
                 // TODO: Show error message in UI
            }

            await InvokeAsync(StateHasChanged);

            Logger.LogInformation("PollDebateState: Checking polling condition. IsDebateInProgress: {DS}, IsDebateFinished: {IDF}",
                _latestDebateState.IsDebateInProgress, newState.IsDebateFinished);
            if (_latestDebateState.IsDebateInProgress && !newState.IsDebateFinished)
            {
                Logger.LogInformation("PollDebateState: Scheduling next poll.");
                _ = Task.Delay(1000).ContinueWith(async _ => await PollDebateState());
            }
            else
            {
                Logger.LogInformation("PollDebateState: Not scheduling next poll. IsDebateInProgress: {DS}, IsDebateFinished: {IDF}",
                    _latestDebateState.IsDebateInProgress, newState.IsDebateFinished);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error polling debate state.");
            _latestDebateState = new DebateState(); // Reset state
            LoadingErrorMessage = $"Error during debate: {ex.Message}";
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task NotifyAudioPlaybackComplete()
    {
        Logger.LogInformation("NotifyAudioPlaybackComplete called from JavaScript.");
        try
        {
            Logger.LogInformation("Signaling audio playback complete to server.");
            var response = await Http.PostAsync("Debate/signal-audio-complete", null);
            response.EnsureSuccessStatusCode();
            Logger.LogInformation("Server acknowledged audio playback complete.");

            if (_latestDebateState.IsDebateFinished)
            {
                Logger.LogInformation("Audio playback complete AND debate is finished. Showing results modal.");
                ShowVotingModal = true;
                await InvokeAsync(StateHasChanged);
            }
            else if (_latestDebateState.IsDebateInProgress)
            {
                _ = Task.Run(async () => await PollDebateState());
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error signaling audio playback completion to orchestrator.");
        }
    }

    private bool IsStartDisabled()
    {
        if (IsLoading || IsFetchingInitialTopic || _latestDebateState.IsGeneratingTurn || ShowVotingModal) return true;
        if (string.IsNullOrEmpty(SelectedRapper1Name) || string.IsNullOrEmpty(SelectedRapper2Name)) return true;
        if (SelectedRapper1Name == SelectedRapper2Name) return true;
        if (string.IsNullOrWhiteSpace(DebateTopicInput)) return true;
        return false;
    }

    private async Task StartDebate()
    {
        if (IsStartDisabled()) return;
        _latestDebateState.IsGeneratingTurn = true;
        ShowVotingModal = false;
        LoadingErrorMessage = null;
        InitialTopicFetchError = null;
        StateHasChanged();

        var rapper1 = Rappers?.FirstOrDefault(r => r.Name == SelectedRapper1Name);
        var rapper2 = Rappers?.FirstOrDefault(r => r.Name == SelectedRapper2Name);
        var topic = new Topic(DebateTopicInput.Trim());

        if (rapper1 == null || rapper2 == null)
        {
            Logger.LogError("Failed to find selected rappers.");
            LoadingErrorMessage = "Selected rapper(s) not found.";
            _latestDebateState.IsGeneratingTurn = false;
            StateHasChanged();
            return;
        }

        Logger.LogInformation("Begin Debate clicked. Rapper1: {R1}, Rapper2: {R2}, Topic: {T}",
            rapper1.Name, rapper2.Name, topic.Title);

        try
        {
            var request = new StartDebateRequest { Rapper1 = rapper1, Rapper2 = rapper2, Topic = topic };
            var response = await Http.PostAsJsonAsync("Debate/start", request);
            response.EnsureSuccessStatusCode();
            var initialState = await response.Content.ReadFromJsonAsync<DebateState>();

            if(initialState != null)
            {
                _latestDebateState = initialState;
                Logger.LogInformation("StartDebate: Received initial state from server. IsDebateInProgress: {InProg}, IsGeneratingTurn: {Gen}, CurrentTurnText: '{Text}'",
                    initialState.IsDebateInProgress, initialState.IsGeneratingTurn, initialState.CurrentTurnText);
                _ = Task.Run(async () => await PollDebateState());
            }
            else
            {
                throw new Exception("Failed to deserialize initial debate state.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during debate setup or start.");
            _latestDebateState = new DebateState(); // Reset state
            LoadingErrorMessage = $"Error starting debate: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task StopDebate()
    {
        Logger.LogInformation("STOP DEBATE button clicked.");
        try
        {
            await JSRuntime.InvokeVoidAsync("stopAudio");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error invoking JS stopAudio function.");
        }
        await Http.PostAsync("Debate/reset", null);
        ResetDebateState();
    }

    private void HandleResultsModalClosed()
    {
        ShowVotingModal = false;
        Logger.LogInformation("Results modal closed.");

        if (!string.IsNullOrEmpty(_latestDebateState.WinnerName) && _latestDebateState.WinnerName != "Draw" && _latestDebateState.WinnerName != "Undecided" && _latestDebateState.WinnerName != "Error Judging" && _latestDebateState.WinnerName != "Error Parsing" && _latestDebateState.WinnerName != "Stats Error")
        {
             Rapper? winner = (_latestDebateState.WinnerName == _latestDebateState.Rapper1?.Name) ? _latestDebateState.Rapper1 : (_latestDebateState.WinnerName == _latestDebateState.Rapper2?.Name) ? _latestDebateState.Rapper2 : null;
             Rapper? loser = (_latestDebateState.WinnerName == _latestDebateState.Rapper1?.Name) ? _latestDebateState.Rapper2 : (_latestDebateState.WinnerName == _latestDebateState.Rapper2?.Name) ? _latestDebateState.Rapper1 : null;

             if (winner != null && loser != null)
             {
                 _ = Task.Run(async () => await UpdateWinLossRecord(winner, loser));
             }
             else
             {
                 Logger.LogWarning("Could not determine valid winner/loser from AI Judge WinnerName '{WinnerName}'.", _latestDebateState.WinnerName);
             }
        }
        else
        {
             Logger.LogInformation("No valid winner determined by AI judge ({WinnerName}). Skipping win/loss update.", _latestDebateState.WinnerName ?? "N/A");
        }

        ResetDebateState();
    }

    private async Task UpdateWinLossRecord(Rapper winner, Rapper loser)
    {
        try
        {
            var response = await Http.PostAsync($"Rappers/update-win-loss?winnerName={winner.Name}&loserName={loser.Name}", null);
            response.EnsureSuccessStatusCode();
            Logger.LogInformation("Win/loss record updated for winner {WinnerName}.", winner.Name);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating win/loss record for Winner: {WinnerName}, Loser: {LoserName}", winner.Name, loser.Name);
        }
    }

    private void ResetDebateState()
    {
        Logger.LogInformation("ResetDebateState called. Resetting UI state.");
        _latestDebateState = new DebateState();
        ShowVotingModal = false;
        StateHasChanged();
    }

    public void Dispose()
    {
         objRef?.Dispose();
        Logger.LogDebug("Home page disposed.");
        GC.SuppressFinalize(this);
    }
}
