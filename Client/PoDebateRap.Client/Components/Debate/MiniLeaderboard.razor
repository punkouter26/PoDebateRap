@using PoDebateRap.Shared.Models
@inject NavigationManager NavManager
@inject ILogger<MiniLeaderboard> Logger

<div class="mini-leaderboard">
    <div class="mini-leaderboard-header">
        <h4>üèÜ Top Champions</h4>
    </div>
    
    @if (IsLoading)
    {
        <div class="mini-leaderboard-loading">
            <div class="spinner-small"></div>
            <p>Loading...</p>
        </div>
    }
    else if (TopRappers == null || !TopRappers.Any())
    {
        <div class="mini-leaderboard-empty">
            <p>No battles yet!</p>
        </div>
    }
    else
    {
        <div class="mini-leaderboard-list">
            @foreach (var (rapper, index) in TopRappers.Select((r, i) => (r, i)))
            {
                <div class="mini-leaderboard-item @GetRankClass(index)">
                    <div class="rank-badge">
                        <span class="rank-icon">@GetRankIcon(index)</span>
                    </div>
                    <div class="rapper-info">
                        <div class="rapper-name">@rapper.Name</div>
                        <div class="rapper-stats">
                            <span class="wins">@rapper.Wins W</span>
                            <span class="separator">-</span>
                            <span class="losses">@rapper.Losses L</span>
                            <span class="win-rate">(@GetWinRate(rapper)%)</span>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <button class="view-full-btn" @onclick="ViewFullLeaderboard">
            View Full Leaderboard ‚Üí
        </button>
    }
</div>

@code {
    [Parameter] public List<Rapper>? Rappers { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    
    private List<Rapper>? TopRappers => Rappers?
        .Where(r => r.TotalDebates > 0)
        .OrderByDescending(r => (double)r.Wins / r.TotalDebates)
        .ThenByDescending(r => r.Wins)
        .Take(3)
        .ToList();

    private string GetRankIcon(int index) => index switch
    {
        0 => "ü•á",
        1 => "ü•à",
        2 => "ü•â",
        _ => ""
    };

    private string GetRankClass(int index) => index switch
    {
        0 => "rank-gold",
        1 => "rank-silver",
        2 => "rank-bronze",
        _ => ""
    };

    private int GetWinRate(Rapper rapper)
    {
        if (rapper.TotalDebates == 0) return 0;
        return (int)Math.Round((double)rapper.Wins / rapper.TotalDebates * 100);
    }

    private void ViewFullLeaderboard()
    {
        Logger.LogInformation("Navigating to full leaderboard from mini widget");
        NavManager.NavigateTo("/leaderboard");
    }
}
