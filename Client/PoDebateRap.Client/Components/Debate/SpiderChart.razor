@using PoDebateRap.Shared.Models

<div class="spider-chart-container">
    <h5 class="chart-title">Rhyme Analytics</h5>
    
    <div class="chart-wrapper">
        <svg viewBox="0 0 400 400" class="spider-svg">
            <!-- Background circles -->
            @for (int i = 5; i >= 1; i--)
            {
                <polygon points="@GetPolygonPoints(i * 20)" 
                         class="grid-polygon" 
                         style="opacity: @(0.1 + i * 0.1)" />
            }
            
            <!-- Axis lines -->
            @for (int i = 0; i < 5; i++)
            {
                var angle = i * 72 - 90;
                var radians = angle * Math.PI / 180;
                var x2 = 200 + 150 * Math.Cos(radians);
                var y2 = 200 + 150 * Math.Sin(radians);
                <line x1="200" y1="200" x2="@x2" y2="@y2" class="axis-line" />
            }
            
            <!-- Axis labels -->
            @{
                var labels = new[] { "Rhyme", "Vocab", "Syllables", "Words", "Alliteration" };
                var labelPositions = new (double x, double y)[5];
                for (int i = 0; i < 5; i++)
                {
                    var angle = i * 72 - 90;
                    var radians = angle * Math.PI / 180;
                    labelPositions[i] = (200 + 175 * Math.Cos(radians), 200 + 175 * Math.Sin(radians));
                }
            }
            <text x="@labelPositions[0].x" y="@labelPositions[0].y" class="axis-label">@labels[0]</text>
            <text x="@labelPositions[1].x" y="@labelPositions[1].y" class="axis-label">@labels[1]</text>
            <text x="@labelPositions[2].x" y="@labelPositions[2].y" class="axis-label">@labels[2]</text>
            <text x="@labelPositions[3].x" y="@labelPositions[3].y" class="axis-label">@labels[3]</text>
            <text x="@labelPositions[4].x" y="@labelPositions[4].y" class="axis-label">@labels[4]</text>
            
            <!-- Rapper 1 data polygon -->
            @if (Rapper1Metrics != null)
            {
                <polygon points="@GetDataPoints(Rapper1Metrics)" 
                         class="data-polygon rapper1-polygon" />
                <polygon points="@GetDataPoints(Rapper1Metrics)" 
                         class="data-polygon-stroke rapper1-stroke" />
            }
            
            <!-- Rapper 2 data polygon -->
            @if (Rapper2Metrics != null)
            {
                <polygon points="@GetDataPoints(Rapper2Metrics)" 
                         class="data-polygon rapper2-polygon" />
                <polygon points="@GetDataPoints(Rapper2Metrics)" 
                         class="data-polygon-stroke rapper2-stroke" />
            }
            
            <!-- Data points -->
            @if (Rapper1Metrics != null)
            {
                var points1 = GetDataPointsArray(Rapper1Metrics);
                @for (int i = 0; i < points1.Length; i++)
                {
                    <circle cx="@points1[i].x" cy="@points1[i].y" r="6" class="data-point rapper1-point" />
                }
            }
            
            @if (Rapper2Metrics != null)
            {
                var points2 = GetDataPointsArray(Rapper2Metrics);
                @for (int i = 0; i < points2.Length; i++)
                {
                    <circle cx="@points2[i].x" cy="@points2[i].y" r="6" class="data-point rapper2-point" />
                }
            }
        </svg>
    </div>
    
    <!-- Legend -->
    <div class="chart-legend">
        <div class="legend-item">
            <span class="legend-color rapper1-color"></span>
            <span class="legend-text">@Rapper1Name</span>
        </div>
        <div class="legend-item">
            <span class="legend-color rapper2-color"></span>
            <span class="legend-text">@Rapper2Name</span>
        </div>
    </div>
    
    <!-- Detailed Stats Table -->
    <div class="stats-breakdown">
        <table class="analytics-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>@Rapper1Name</th>
                    <th>@Rapper2Name</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Rhyme Density</td>
                    <td class="@GetCompareClass(Rapper1Metrics?.RhymeDensity ?? 0, Rapper2Metrics?.RhymeDensity ?? 0)">
                        @(Rapper1Metrics?.RhymeDensity.ToString("F1") ?? "0")%
                    </td>
                    <td class="@GetCompareClass(Rapper2Metrics?.RhymeDensity ?? 0, Rapper1Metrics?.RhymeDensity ?? 0)">
                        @(Rapper2Metrics?.RhymeDensity.ToString("F1") ?? "0")%
                    </td>
                </tr>
                <tr>
                    <td>Vocabulary</td>
                    <td class="@GetCompareClass(Rapper1Metrics?.VocabularyRichness ?? 0, Rapper2Metrics?.VocabularyRichness ?? 0)">
                        @(Rapper1Metrics?.VocabularyRichness.ToString("F1") ?? "0")%
                    </td>
                    <td class="@GetCompareClass(Rapper2Metrics?.VocabularyRichness ?? 0, Rapper1Metrics?.VocabularyRichness ?? 0)">
                        @(Rapper2Metrics?.VocabularyRichness.ToString("F1") ?? "0")%
                    </td>
                </tr>
                <tr>
                    <td>Syllable Complexity</td>
                    <td class="@GetCompareClass(Rapper1Metrics?.SyllableComplexity ?? 0, Rapper2Metrics?.SyllableComplexity ?? 0)">
                        @(Rapper1Metrics?.SyllableComplexity.ToString("F1") ?? "0")%
                    </td>
                    <td class="@GetCompareClass(Rapper2Metrics?.SyllableComplexity ?? 0, Rapper1Metrics?.SyllableComplexity ?? 0)">
                        @(Rapper2Metrics?.SyllableComplexity.ToString("F1") ?? "0")%
                    </td>
                </tr>
                <tr>
                    <td>Word Complexity</td>
                    <td class="@GetCompareClass(Rapper1Metrics?.WordComplexity ?? 0, Rapper2Metrics?.WordComplexity ?? 0)">
                        @(Rapper1Metrics?.WordComplexity.ToString("F1") ?? "0")%
                    </td>
                    <td class="@GetCompareClass(Rapper2Metrics?.WordComplexity ?? 0, Rapper1Metrics?.WordComplexity ?? 0)">
                        @(Rapper2Metrics?.WordComplexity.ToString("F1") ?? "0")%
                    </td>
                </tr>
                <tr>
                    <td>Alliteration</td>
                    <td class="@GetCompareClass(Rapper1Metrics?.AlliterationScore ?? 0, Rapper2Metrics?.AlliterationScore ?? 0)">
                        @(Rapper1Metrics?.AlliterationScore.ToString("F1") ?? "0")%
                    </td>
                    <td class="@GetCompareClass(Rapper2Metrics?.AlliterationScore ?? 0, Rapper1Metrics?.AlliterationScore ?? 0)">
                        @(Rapper2Metrics?.AlliterationScore.ToString("F1") ?? "0")%
                    </td>
                </tr>
                <tr class="total-row">
                    <td>Total Words</td>
                    <td>@(Rapper1Metrics?.TotalWords ?? 0)</td>
                    <td>@(Rapper2Metrics?.TotalWords ?? 0)</td>
                </tr>
                <tr>
                    <td>Unique Words</td>
                    <td>@(Rapper1Metrics?.UniqueWords ?? 0)</td>
                    <td>@(Rapper2Metrics?.UniqueWords ?? 0)</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

@code {
    [Parameter] public RapperRhymeMetrics? Rapper1Metrics { get; set; }
    [Parameter] public RapperRhymeMetrics? Rapper2Metrics { get; set; }
    [Parameter] public string Rapper1Name { get; set; } = "Rapper 1";
    [Parameter] public string Rapper2Name { get; set; } = "Rapper 2";

    private const double CenterX = 200;
    private const double CenterY = 200;
    private const double MaxRadius = 150;

    private string GetPolygonPoints(double percentage)
    {
        var radius = MaxRadius * (percentage / 100.0);
        var points = new List<string>();
        
        for (int i = 0; i < 5; i++)
        {
            var angle = i * 72 - 90; // Start from top
            var radians = angle * Math.PI / 180;
            var x = CenterX + radius * Math.Cos(radians);
            var y = CenterY + radius * Math.Sin(radians);
            points.Add($"{x:F1},{y:F1}");
        }
        
        return string.Join(" ", points);
    }

    private string GetDataPoints(RapperRhymeMetrics metrics)
    {
        var values = new[] {
            metrics.RhymeDensity,
            metrics.VocabularyRichness,
            metrics.SyllableComplexity,
            metrics.WordComplexity,
            metrics.AlliterationScore
        };

        var points = new List<string>();
        
        for (int i = 0; i < 5; i++)
        {
            var radius = MaxRadius * (values[i] / 100.0);
            var angle = i * 72 - 90;
            var radians = angle * Math.PI / 180;
            var x = CenterX + radius * Math.Cos(radians);
            var y = CenterY + radius * Math.Sin(radians);
            points.Add($"{x:F1},{y:F1}");
        }
        
        return string.Join(" ", points);
    }

    private (double x, double y)[] GetDataPointsArray(RapperRhymeMetrics metrics)
    {
        var values = new[] {
            metrics.RhymeDensity,
            metrics.VocabularyRichness,
            metrics.SyllableComplexity,
            metrics.WordComplexity,
            metrics.AlliterationScore
        };

        var points = new (double x, double y)[5];
        
        for (int i = 0; i < 5; i++)
        {
            var radius = MaxRadius * (values[i] / 100.0);
            var angle = i * 72 - 90;
            var radians = angle * Math.PI / 180;
            points[i] = (CenterX + radius * Math.Cos(radians), CenterY + radius * Math.Sin(radians));
        }
        
        return points;
    }

    private string GetCompareClass(double value1, double value2)
    {
        if (value1 > value2 + 5) return "stat-winner";
        if (value1 < value2 - 5) return "stat-loser";
        return "stat-tie";
    }
}
