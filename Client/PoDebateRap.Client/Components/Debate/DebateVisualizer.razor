@using PoDebateRap.Shared.Models
@using Radzen
@using Radzen.Blazor
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="debate-visualizer" id="debate-visualizer-@_instanceId">
    <div class="rapper-profiles">
        <!-- Rapper 1 Profile Area -->
        <RadzenCard class="@($"rapper-profile {(IsRapper1Active ? "active-border" : "")}")">
            <RadzenStack Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenText TextStyle="TextStyle.H5" class="rapper-name">@(Rapper1?.Name ?? "Rapper 1")</RadzenText>
                <RadzenBadge BadgeStyle="@(IsRapper1Active ? BadgeStyle.Warning : BadgeStyle.Secondary)" 
                             IsPill="true" 
                             class="@($"rapper-mic {(IsRapper1Active ? "blinking" : "")}")">
                    üé§
                </RadzenBadge>
            </RadzenStack>
        </RadzenCard>

        <!-- VS Separator -->
        <div class="vs-separator">
            <RadzenBadge BadgeStyle="BadgeStyle.Primary" IsPill="true" class="vs-badge">
                ‚öñÔ∏è VS
            </RadzenBadge>
        </div>

        <!-- Rapper 2 Profile Area -->
        <RadzenCard class="@($"rapper-profile {(IsRapper2Active ? "active-border" : "")}")">
            <RadzenStack Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenText TextStyle="TextStyle.H5" class="rapper-name">@(Rapper2?.Name ?? "Rapper 2")</RadzenText>
                <RadzenBadge BadgeStyle="@(IsRapper2Active ? BadgeStyle.Warning : BadgeStyle.Secondary)" 
                             IsPill="true" 
                             class="@($"rapper-mic {(IsRapper2Active ? "blinking" : "")}")">
                    üé§
                </RadzenBadge>
            </RadzenStack>
        </RadzenCard>
    </div>

    <!-- Debate Text Display Area with Navigation -->
    <div class="debate-text-area">
        @if (ShowNavigation && CurrentTurnNumber > 1)
        {
            <button class="turn-nav-btn turn-nav-prev" @onclick="OnPreviousTurn" title="Previous Turn (Swipe Right)">
                ‚Äπ
            </button>
        }
        
        <pre class="lyrics @(IsNewLyrics ? "fade-in" : "") @(IsSwiping ? "swiping" : "")">@CurrentTurnText</pre>
        
        @if (ShowNavigation && CurrentTurnNumber < TotalTurns)
        {
            <button class="turn-nav-btn turn-nav-next" @onclick="OnNextTurn" title="Next Turn (Swipe Left)">
                ‚Ä∫
            </button>
        }
        
        @if (ShowNavigation)
        {
            <div class="swipe-hint">
                <small>üí° Swipe left/right to navigate turns</small>
            </div>
        }
    </div>

    <!-- Progress Indicator Area -->
    <div class="progress-indicator">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1.5rem">
            <RadzenProgressBarCircular @ref="progressCircular"
                                       Value="@ProgressPercentage" 
                                       Size="ProgressBarCircularSize.Medium"
                                       ShowValue="true"
                                       Mode="ProgressBarMode.Determinate">
                <Template>
                    <RadzenText TextStyle="TextStyle.Caption" class="progress-text">
                        @CurrentTurnNumber/@TotalTurns
                    </RadzenText>
                </Template>
            </RadzenProgressBarCircular>
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Body1" class="turn-label">Round @CurrentTurnNumber of @TotalTurns</RadzenText>
                <RadzenProgressBar Value="@ProgressPercentage" 
                                   ShowValue="false" 
                                   Mode="ProgressBarMode.Determinate"
                                   class="progress-bar-linear" />
            </RadzenStack>
        </RadzenStack>
    </div>
</div>

@code {
    [Parameter] public Rapper? Rapper1 { get; set; }
    [Parameter] public Rapper? Rapper2 { get; set; }
    [Parameter] public string CurrentTurnText { get; set; } = "The debate hasn't started yet...";
    [Parameter] public bool IsRapper1Active { get; set; } = false;
    [Parameter] public bool IsRapper2Active { get; set; } = false;
    [Parameter] public int CurrentTurnNumber { get; set; } = 0;
    [Parameter] public int TotalTurns { get; set; } = 10;
    [Parameter] public bool ShowNavigation { get; set; } = false;
    [Parameter] public EventCallback<int> OnTurnChanged { get; set; }

    private string _previousText = string.Empty;
    private bool IsNewLyrics => CurrentTurnText != _previousText;
    private bool IsSwiping = false;
    private string _instanceId = Guid.NewGuid().ToString("N");
    private DotNetObjectReference<DebateVisualizer>? _dotNetRef;
    private RadzenProgressBarCircular? progressCircular;
    
    // Progress as percentage for Radzen components
    private double ProgressPercentage => TotalTurns > 0 ? (double)CurrentTurnNumber / TotalTurns * 100 : 0;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        _previousText = CurrentTurnText;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ShowNavigation)
        {
            try
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("initializeGestures", _dotNetRef, $"#debate-visualizer-{_instanceId}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing gestures: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task OnSwipeLeft()
    {
        if (CurrentTurnNumber < TotalTurns)
        {
            await OnNextTurn();
        }
    }

    [JSInvokable]
    public async Task OnSwipeRight()
    {
        if (CurrentTurnNumber > 1)
        {
            await OnPreviousTurn();
        }
    }

    [JSInvokable]
    public Task OnSwipeDown()
    {
        // Could be used to minimize/collapse the debate view
        Console.WriteLine("Swipe down detected - could minimize debate");
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnSwipeUp()
    {
        // Could be used to expand or show additional details
        Console.WriteLine("Swipe up detected - could expand debate");
        return Task.CompletedTask;
    }

    private async Task OnNextTurn()
    {
        if (CurrentTurnNumber < TotalTurns)
        {
            IsSwiping = true;
            StateHasChanged();
            await Task.Delay(200);
            
            await OnTurnChanged.InvokeAsync(CurrentTurnNumber + 1);
            
            IsSwiping = false;
            StateHasChanged();
        }
    }

    private async Task OnPreviousTurn()
    {
        if (CurrentTurnNumber > 1)
        {
            IsSwiping = true;
            StateHasChanged();
            await Task.Delay(200);
            
            await OnTurnChanged.InvokeAsync(CurrentTurnNumber - 1);
            
            IsSwiping = false;
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("destroyGestures", $"#debate-visualizer-{_instanceId}");
            _dotNetRef?.Dispose();
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}
