@using PoDebateRap.Shared.Models
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@* Removed: @using MudBlazor *@

<div class="debate-visualizer" id="debate-visualizer-@_instanceId">
    <div class="rapper-profiles">
        <!-- Rapper 1 Profile Area -->
        <div class="rapper-profile @(IsRapper1Active ? "active-border" : "")">
            <h5>@(Rapper1?.Name ?? "Rapper 1")</h5>
            <span class="rapper-mic @(IsRapper1Active ? "blinking active-mic" : "inactive-mic")">üé§</span>
        </div>

        <!-- VS Separator -->
        <div class="vs-separator">
             <span class="gavel-icon">‚öñÔ∏è</span>
        </div>

        <!-- Rapper 2 Profile Area -->
        <div class="rapper-profile @(IsRapper2Active ? "active-border" : "")">
            <h5>@(Rapper2?.Name ?? "Rapper 2")</h5>
            <span class="rapper-mic @(IsRapper2Active ? "blinking active-mic" : "inactive-mic")">üé§</span>
        </div>
    </div>

    <!-- Debate Text Display Area with Navigation -->
    <div class="debate-text-area">
        @if (ShowNavigation && CurrentTurnNumber > 1)
        {
            <button class="turn-nav-btn turn-nav-prev" @onclick="OnPreviousTurn" title="Previous Turn (Swipe Right)">
                ‚Äπ
            </button>
        }
        
        <pre class="lyrics @(IsNewLyrics ? "fade-in" : "") @(IsSwiping ? "swiping" : "")">@CurrentTurnText</pre>
        
        @if (ShowNavigation && CurrentTurnNumber < TotalTurns)
        {
            <button class="turn-nav-btn turn-nav-next" @onclick="OnNextTurn" title="Next Turn (Swipe Left)">
                ‚Ä∫
            </button>
        }
        
        @if (ShowNavigation)
        {
            <div class="swipe-hint">
                <small>üí° Swipe left/right to navigate turns</small>
            </div>
        }
    </div>

    <!-- Progress Indicator Area -->
    <div class="progress-indicator">
        <p class="turn-text">Turn @CurrentTurnNumber / @TotalTurns</p>
        <progress class="debate-progress" value="@CurrentTurnNumber" max="@TotalTurns"></progress>
    </div>
</div>

<style>
    .lyrics {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 1.1rem;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        padding: 1rem;
        background: transparent;
        border: none;
        color: inherit;
        text-align: left;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .debate-text-area {
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    }
</style>

@code {
    [Parameter] public Rapper? Rapper1 { get; set; }
    [Parameter] public Rapper? Rapper2 { get; set; }
    [Parameter] public string CurrentTurnText { get; set; } = "The debate hasn't started yet...";
    [Parameter] public bool IsRapper1Active { get; set; } = false;
    [Parameter] public bool IsRapper2Active { get; set; } = false;
    [Parameter] public int CurrentTurnNumber { get; set; } = 0;
    [Parameter] public int TotalTurns { get; set; } = 10;
    [Parameter] public bool ShowNavigation { get; set; } = false;
    [Parameter] public EventCallback<int> OnTurnChanged { get; set; }

    private string _previousText = string.Empty;
    private bool IsNewLyrics => CurrentTurnText != _previousText;
    private bool IsSwiping = false;
    private string _instanceId = Guid.NewGuid().ToString("N");
    private DotNetObjectReference<DebateVisualizer>? _dotNetRef;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        _previousText = CurrentTurnText;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ShowNavigation)
        {
            try
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("initializeGestures", _dotNetRef, $"#debate-visualizer-{_instanceId}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing gestures: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task OnSwipeLeft()
    {
        if (CurrentTurnNumber < TotalTurns)
        {
            await OnNextTurn();
        }
    }

    [JSInvokable]
    public async Task OnSwipeRight()
    {
        if (CurrentTurnNumber > 1)
        {
            await OnPreviousTurn();
        }
    }

    [JSInvokable]
    public Task OnSwipeDown()
    {
        // Could be used to minimize/collapse the debate view
        Console.WriteLine("Swipe down detected - could minimize debate");
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task OnSwipeUp()
    {
        // Could be used to expand or show additional details
        Console.WriteLine("Swipe up detected - could expand debate");
        return Task.CompletedTask;
    }

    private async Task OnNextTurn()
    {
        if (CurrentTurnNumber < TotalTurns)
        {
            IsSwiping = true;
            StateHasChanged();
            await Task.Delay(200);
            
            await OnTurnChanged.InvokeAsync(CurrentTurnNumber + 1);
            
            IsSwiping = false;
            StateHasChanged();
        }
    }

    private async Task OnPreviousTurn()
    {
        if (CurrentTurnNumber > 1)
        {
            IsSwiping = true;
            StateHasChanged();
            await Task.Delay(200);
            
            await OnTurnChanged.InvokeAsync(CurrentTurnNumber - 1);
            
            IsSwiping = false;
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("destroyGestures", $"#debate-visualizer-{_instanceId}");
            _dotNetRef?.Dispose();
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}
