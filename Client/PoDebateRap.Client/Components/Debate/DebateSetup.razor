@using PoDebateRap.Shared.Models

<div class="setup-section">
    <!-- Topic Input Section - Now Primary -->
    <div class="topic-input-section-primary">
        <label for="debateTopicInput" class="topic-label">What should they debate?</label>
        <div class="topic-input-wrapper">
            <input type="text" id="debateTopicInput" 
                   placeholder="@TopicPlaceholder"
                   value="@DebateTopicInput" 
                   @oninput="HandleTopicInput"
                   maxlength="150" 
                   disabled="@IsDisabled"
                   class="topic-input-large" />
        </div>
        @if (!string.IsNullOrEmpty(InitialTopicFetchError) && string.IsNullOrWhiteSpace(DebateTopicInput))
        {
            <div class="text-warning mt-1"><small>@InitialTopicFetchError</small></div>
        }
    </div>

    <!-- Quick Battle Button - Main Action -->
    <div class="quick-battle-container-primary">
        @if (!IsDebateInProgress)
        {
            <button class="btn-quick-battle-large" @onclick="HandleQuickBattle" disabled="@(IsQuickBattleDisabled())">
                @if (IsLoading || IsFetchingTopic)
                {
                    <span class="spinner"></span>
                    <span>Loading...</span>
                }
                else if (IsStarting)
                {
                    <span class="spinner"></span>
                    <span>Starting Battle...</span>
                }
                else
                {
                    <span class="quick-icon">⚡</span>
                    <span>START BATTLE</span>
                }
            </button>
            <p class="quick-battle-hint">Two random legendary rappers will face off!</p>
        }
        else
        {
            <!-- Show Stop Button -->
            <button class="btn-danger-large" @onclick="OnStopDebate" disabled="@IsVoting">
                @if (IsStarting)
                {
                    <span class="spinner"></span>
                    <span>Generating...</span>
                }
                else
                {
                    <span>⏹️ STOP DEBATE</span>
                }
            </button>
        }
    </div>
</div>

@code {
    [Parameter] public List<Rapper>? Rappers { get; set; }
    
    // Keep these for compatibility but they're now set automatically
    private string? _selectedRapper1Name;
    [Parameter] 
    public string? SelectedRapper1Name 
    { 
        get => _selectedRapper1Name;
        set => _selectedRapper1Name = value;
    }
    [Parameter] public EventCallback<string> SelectedRapper1NameChanged { get; set; }
    
    private string? _selectedRapper2Name;
    [Parameter] 
    public string? SelectedRapper2Name 
    { 
        get => _selectedRapper2Name;
        set => _selectedRapper2Name = value;
    }
    [Parameter] public EventCallback<string> SelectedRapper2NameChanged { get; set; }
    [Parameter] public string? DebateTopicInput { get; set; }
    [Parameter] public EventCallback<string> DebateTopicInputChanged { get; set; }
    [Parameter] public bool IsDisabled { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public bool IsStarting { get; set; }
    [Parameter] public bool IsFetchingTopic { get; set; }
    [Parameter] public bool IsDebateInProgress { get; set; }
    [Parameter] public bool IsVoting { get; set; }
    [Parameter] public bool IsStartDisabled { get; set; }
    [Parameter] public string? InitialTopicFetchError { get; set; }
    [Parameter] public string TopicPlaceholder { get; set; } = "e.g., Is AI good for humanity?";
    [Parameter] public EventCallback OnStartDebate { get; set; }
    [Parameter] public EventCallback OnStopDebate { get; set; }
    [Parameter] public EventCallback OnQuickBattle { get; set; }

    private async Task HandleTopicInput(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString();
        DebateTopicInput = newValue;
        await DebateTopicInputChanged.InvokeAsync(DebateTopicInput);
    }

    private bool IsQuickBattleDisabled()
    {
        return IsLoading || IsFetchingTopic || IsDisabled || IsStarting || Rappers == null || Rappers.Count < 2 || string.IsNullOrWhiteSpace(DebateTopicInput);
    }

    private async Task HandleQuickBattle()
    {
        if (!IsQuickBattleDisabled())
        {
            await OnQuickBattle.InvokeAsync();
        }
    }
}

