flowchart TD
    Start([User Opens App]) --> SelectRappers[Select Rapper 1 & Rapper 2]
    SelectRappers --> ValidateRappers{Same Rapper?}
    ValidateRappers -->|Yes| ShowError1[Show Error:<br/>Must select different rappers]
    ShowError1 --> SelectRappers
    ValidateRappers -->|No| SelectTopic[Select Topic Source]
    
    SelectTopic --> TopicChoice{Topic Type?}
    TopicChoice -->|Trending| LoadNews[Fetch NewsAPI Headlines]
    LoadNews --> DisplayHeadlines[Display Top 10 Headlines]
    DisplayHeadlines --> PickHeadline[User Selects Headline]
    PickHeadline --> ValidateTopic
    
    TopicChoice -->|Custom| EnterTopic[User Enters Custom Topic]
    EnterTopic --> ValidateTopic{Topic â‰¥ 10 chars?}
    ValidateTopic -->|No| ShowError2[Button Disabled]
    ShowError2 --> EnterTopic
    ValidateTopic -->|Yes| EnableButton[Enable BEGIN DEBATE Button]
    
    EnableButton --> UserClicksStart{User Clicks<br/>BEGIN DEBATE?}
    UserClicksStart -->|No| Wait[Wait for User]
    Wait --> UserClicksStart
    UserClicksStart -->|Yes| StartDebate[POST /api/debate/start]
    
    StartDebate --> CreateDebate[Create Debate Record]
    CreateDebate --> GetDebateId[Receive debateId]
    GetDebateId --> ShowArena[Show Debate Arena]
    
    ShowArena --> TurnLoop{More Turns?}
    TurnLoop -->|Yes| GenerateTurn[Generate Next Turn]
    GenerateTurn --> AIGenerate[AI Generates Verse]
    AIGenerate --> TTSConvert[Convert to Audio]
    TTSConvert --> DisplayVerse[Display Verse in UI]
    DisplayVerse --> PlayAudio[Auto-Play Audio]
    PlayAudio --> SaveTurn[Save Turn to Storage]
    SaveTurn --> SignalRBroadcast[Broadcast via SignalR]
    SignalRBroadcast --> UpdateUI[Update Turn Counter]
    UpdateUI --> TurnLoop
    
    TurnLoop -->|No, Max Turns| JudgeDebate[POST /api/debate/judge]
    JudgeDebate --> AIJudge[AI Analyzes All Verses]
    AIJudge --> DetermineWinner[Determine Winner]
    DetermineWinner --> GenerateReasoning[Generate Reasoning]
    GenerateReasoning --> DisplayWinner[Display Winner & Reasoning]
    DisplayWinner --> ShowNewDebateButton[Show NEW DEBATE Button]
    
    ShowNewDebateButton --> UserAction{User Action?}
    UserAction -->|New Debate| ResetForm[Reset Form]
    ResetForm --> SelectRappers
    UserAction -->|Exit| End([End])
    
    %% Error Handling
    StartDebate -->|API Error| ShowAPIError[Show Error Message]
    ShowAPIError --> EnableButton
    
    AIGenerate -->|Error| ShowAIError[Show AI Error]
    ShowAIError --> TurnLoop
    
    TTSConvert -->|Error| ShowTTSError[Show TTS Error]
    ShowTTSError --> TurnLoop
    
    %% Styling
    classDef inputStyle fill:#ffd700,stroke:#333,stroke-width:2px,color:#000
    classDef processStyle fill:#61dafb,stroke:#333,stroke-width:2px,color:#000
    classDef decisionStyle fill:#ff6b6b,stroke:#333,stroke-width:2px,color:#fff
    classDef errorStyle fill:#f44336,stroke:#333,stroke-width:2px,color:#fff
    classDef successStyle fill:#4caf50,stroke:#333,stroke-width:2px,color:#fff
    
    class SelectRappers,SelectTopic,EnterTopic,PickHeadline inputStyle
    class StartDebate,GenerateTurn,AIGenerate,TTSConvert,JudgeDebate,AIJudge processStyle
    class ValidateRappers,TopicChoice,ValidateTopic,UserClicksStart,TurnLoop,UserAction decisionStyle
    class ShowError1,ShowError2,ShowAPIError,ShowAIError,ShowTTSError errorStyle
    class DisplayWinner,ShowNewDebateButton successStyle
